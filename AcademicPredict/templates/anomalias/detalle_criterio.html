{% extends 'anomalias/base.html' %}
{% load filters %}
{% block title %}Detalle del Criterio - {{ criterio.nombre }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3 mb-0">{{ criterio.nombre }}</h1>
            <p class="text-muted">{{ criterio.descripcion }}</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group">
                <a href="{% url 'configuracion_criterios' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Volver
                </a>
                <a href="{% url 'editar_criterio' criterio.id %}" class="btn btn-warning">
                    <i class="fas fa-edit me-2"></i>Editar
                </a>
                {% if criterio.activo %}
                <form method="post" action="{% url 'ejecutar_analisis' criterio.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-play me-2"></i>Ejecutar Análisis
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Información básica -->
    <div class="row mb-4">
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Información Básica</h5>
                </div>
                <div class="card-body">
                    <p><strong>Carrera:</strong> {{ criterio.carrera.nombre|default:"Todas las carreras" }}</p>
                    <p><strong>Semestre:</strong> {{ criterio.semestre|default:"Todos los semestres" }}</p>
                    <p><strong>Estado:</strong> 
                        <span class="badge {% if criterio.activo %}bg-success{% else %}bg-secondary{% endif %}">
                            {% if criterio.activo %}Activo{% else %}Inactivo{% endif %}
                        </span>
                    </p>
                    <p><strong>Creado:</strong> {{ criterio.fecha_creacion|date:"d/m/Y H:i" }}</p>
                    <p><strong>Creado por:</strong> {{ criterio.creado_por.get_full_name|default:criterio.creado_por.username }}</p>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Parámetros del Modelo</h5>
                </div>
                <div class="card-body">
                    <p><strong>Tasa de Contaminación:</strong> {{ criterio.contamination_rate|floatformat:3 }} ({{ criterio.contamination_rate|floatformat:1|mul:100 }}%)</p>
                    <p><strong>Estimadores:</strong> {{ criterio.n_estimators }}</p>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Umbrales</h5>
                </div>
                <div class="card-body">
                    <p><strong>Promedio mínimo:</strong> {{ criterio.umbral_promedio_min }}</p>
                    <p><strong>Asistencia mínima:</strong> {{ criterio.umbral_asistencia_min }}%</p>
                    <p><strong>Uso plataforma mínimo:</strong> {{ criterio.umbral_uso_plataforma_min }}%</p>
                    <p><strong>Variación máxima notas:</strong> {{ criterio.umbral_variacion_notas }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3>{{ total_ejecuciones }}</h3>
                    <p class="mb-0">Total Ejecuciones</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3>{{ ejecuciones_exitosas }}</h3>
                    <p class="mb-0">Ejecuciones Exitosas</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h3>{{ total_anomalias }}</h3>
                    <p class="mb-0">Anomalías Detectadas</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3>{% if ultima_ejecucion %}{{ ultima_ejecucion.tiempo_ejecucion|floatformat:1 }}s{% else %}N/A{% endif %}</h3>
                    <p class="mb-0">Última Ejecución</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Última ejecución -->
    {% if ultima_ejecucion %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Última Ejecución</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Fecha:</strong> {{ ultima_ejecucion.fecha_ejecucion|date:"d/m/Y H:i" }}
                        </div>
                        <div class="col-md-3">
                            <strong>Estado:</strong> 
                            <span class="badge {% if ultima_ejecucion.exitoso %}bg-success{% else %}bg-danger{% endif %}">
                                {% if ultima_ejecucion.exitoso %}Exitosa{% else %}Error{% endif %}
                            </span>
                        </div>
                        <div class="col-md-3">
                            <strong>Estudiantes analizados:</strong> {{ ultima_ejecucion.total_estudiantes_analizados }}
                        </div>
                        <div class="col-md-3">
                            <strong>Anomalías detectadas:</strong> {{ ultima_ejecucion.anomalias_detectadas }}
                        </div>
                    </div>
                    {% if not ultima_ejecucion.exitoso and ultima_ejecucion.mensaje_error %}
                    <div class="alert alert-danger mt-2">
                        <strong>Error:</strong> {{ ultima_ejecucion.mensaje_error }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Distribución por tipo de anomalía -->
    {% if anomalias_por_tipo %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Tipos de Anomalías Detectadas</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Tipo de Anomalía</th>
                                    <th>Cantidad</th>
                                    <th>Porcentaje</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tipo in anomalias_por_tipo %}
                                <tr>
                                    <td>{{ tipo.tipo_anomalia|capfirst }}</td>
                                    <td>{{ tipo.count }}</td>
                                    <td>{{ tipo.count|mul:100|div:total_anomalias|floatformat:1 }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
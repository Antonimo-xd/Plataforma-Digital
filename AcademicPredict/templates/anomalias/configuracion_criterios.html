{% extends 'anomalias/base.html' %}

{% block title %}Configuraci√≥n de Criterios{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3 mb-0">
                <i class="fas fa-cogs me-2"></i>
                Configuraci√≥n de Criterios
            </h1>
            <p class="text-muted">Gesti√≥n de criterios de detecci√≥n de anomal√≠as</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'crear_criterio' %}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Crear Nuevo Criterio
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Criterios Existentes
                    </h5>
                </div>
                <div class="card-body">
                    {% if criterios %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Carrera</th>
                                        <th>Semestre</th>
                                        <th>Contaminaci√≥n</th>
                                        <th>Estado</th>
                                        <th>Fecha Creaci√≥n</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for criterio in criterios %}
                                    <tr>
                                        <td>
                                            <strong>{{ criterio.nombre }}</strong>
                                            <br>
                                            <small class="text-muted">{{ criterio.descripcion|truncatechars:50 }}</small>
                                        </td>
                                        <td>
                                            {% if criterio.carrera %}
                                                {{ criterio.carrera.nombre }}
                                            {% else %}
                                                <span class="text-muted">Todas</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if criterio.semestre %}
                                                Semestre {{ criterio.semestre }}
                                            {% else %}
                                                <span class="text-muted">Todos</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ criterio.contamination_rate|floatformat:2 }}</td>
                                        <td>
                                            {% if criterio.activo %}
                                                <span class="badge bg-success">Activo</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Inactivo</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ criterio.fecha_creacion|date:"d/m/Y H:i" }}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <!-- Ver detalles -->
                                                <a href="{% url 'detalle_criterio' criterio.id %}" 
                                                class="btn btn-outline-primary" 
                                                title="Ver detalles">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                
                                                <!-- Editar criterio -->
                                                <a href="{% url 'editar_criterio' criterio.id %}" 
                                                class="btn btn-outline-warning" 
                                                title="Editar criterio">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                
                                                <!-- Ejecutar an√°lisis -->
                                                <button class="btn btn-outline-success" 
                                                        onclick="ejecutarAnalisis({{ criterio.id }})" 
                                                        title="Ejecutar an√°lisis">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                                
                                                <!-- Eliminar criterio -->
                                                <button class="btn btn-outline-danger" 
                                                        onclick="confirmarEliminarCriterio({{ criterio.id }}, '{{ criterio.nombre|escapejs }}')" 
                                                        title="Eliminar criterio">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No hay criterios configurados</h5>
                            <p class="text-muted">Crea tu primer criterio de detecci√≥n de anomal√≠as para comenzar.</p>
                            <a href="{% url 'crear_criterio' %}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Crear Primer Criterio
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if criterios %}
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Informaci√≥n sobre Criterios
                    </h6>
                </div>
                <div class="card-body">
                    <small>
                        <ul class="mb-0">
                            <li><strong>Tasa de Contaminaci√≥n:</strong> Porcentaje esperado de anomal√≠as (0.1 = 10%)</li>
                            <li><strong>Estimadores:</strong> N√∫mero de √°rboles en el Isolation Forest</li>
                            <li><strong>Umbrales:</strong> Valores m√≠nimos esperados para clasificar como normal</li>
                        </ul>
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Estad√≠sticas
                    </h6>
                </div>
                <div class="card-body">
                    <small>
                        <p><strong>Total criterios:</strong> {{ criterios|length }}</p>
                        <p><strong>Criterios activos:</strong> {{ criterios|length }}</p>
                        <p class="mb-0"><strong>√öltimo an√°lisis:</strong> <em>Pendiente</em></p>
                    </small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de confirmaci√≥n para eliminar criterio -->
<div class="modal fade" id="modalEliminarCriterio" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminaci√≥n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-warning me-2"></i>
                    <strong>¬°Atenci√≥n!</strong> Esta acci√≥n no se puede deshacer.
                </div>
                
                <p>¬øEst√°s seguro de que deseas eliminar el criterio:</p>
                <p class="fw-bold text-center" id="nombreCriterioEliminar"></p>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Nota:</strong> Si este criterio tiene anomal√≠as asociadas, ser√° desactivado en lugar de eliminado para preservar el historial.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="formEliminarCriterio" method="post" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="confirmar" value="true">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Eliminar Criterio
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de progreso de an√°lisis -->
<div class="modal fade" id="modalProgresoAnalisis" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cogs me-2"></i>Ejecutando An√°lisis
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Analizando...</span>
                    </div>
                </div>
                <p id="mensajeProgreso">Iniciando an√°lisis de anomal√≠as...</p>
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" style="width: 0%" id="barraProgreso"></div>
                </div>
                <small class="text-muted" id="detalleProgreso">Preparando datos...</small>
            </div>
        </div>
    </div>
</div>

<script>

function ejecutarAnalisis(criterioId) {
    console.log(`üöÄ Ejecutando an√°lisis para criterio ${criterioId}`);
    
    // Mostrar modal de progreso
    const modal = new bootstrap.Modal(document.getElementById('modalProgresoAnalisis'));
    
    // Actualizar modal para que muestre un estado de "procesando" simple
    document.getElementById('mensajeProgreso').textContent = 'Ejecutando an√°lisis...';
    document.getElementById('detalleProgreso').textContent = 'Esto puede tardar varios segundos. Por favor, espere.';
    const barraProgreso = document.getElementById('barraProgreso');
    barraProgreso.style.width = '100%';
    barraProgreso.classList.add('progress-bar-animated', 'progress-bar-striped');

    modal.show();
    
    // Iniciar an√°lisis
    fetch(`/cpa/criterios/${criterioId}/ejecutar/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        // ‚úÖ CORRECCI√ìN:
        // Ya no llamamos a 'actualizarProgreso'.
        // Llamamos a 'finalizarAnalisis' directamente con los datos.
        if (data.exitoso) {
            finalizarAnalisis(data); 
        } else {
            mostrarErrorAnalisis(data.error || 'Error desconocido');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarErrorAnalisis(error.message || 'Error de conexi√≥n'); 
    });
}

function confirmarEliminarCriterio(criterioId, nombreCriterio) {
    // Llenar modal con informaci√≥n
    document.getElementById('nombreCriterioEliminar').textContent = nombreCriterio;
    
    // Configurar formulario
    const form = document.getElementById('formEliminarCriterio');
    form.action = `/cpa/criterios/${criterioId}/eliminar/`;
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalEliminarCriterio'));
    modal.show();
}

function finalizarAnalisis(data) {
    // Cerrar modal de progreso
    bootstrap.Modal.getInstance(document.getElementById('modalProgresoAnalisis')).hide();
    
    // Restaurar barra de progreso para la pr√≥xima vez
    const barraProgreso = document.getElementById('barraProgreso');
    barraProgreso.style.width = '0%';
    barraProgreso.classList.remove('progress-bar-animated', 'progress-bar-striped');

    // Mostrar resultados
    if (data.exitoso) {
        mostrarNotificacion(
            `‚úÖ An√°lisis completado: ${data.anomalias_detectadas} anomal√≠as detectadas en ${data.tiempo_ejecucion}s`,
            'success'
        );
        
        // Recargar p√°gina despu√©s de un momento
        setTimeout(() => {
            // ‚úÖ CORRECCI√ìN: Redirigir al listado de anomal√≠as
            window.location.href = "{% url 'listado_anomalias' %}";
        }, 2000); // 2 segundos de espera para que el usuario lea el mensaje
    } else {
        mostrarErrorAnalisis(data.error || 'El an√°lisis no se complet√≥ correctamente');
    }
}

function mostrarErrorAnalisis(error) {
    // Cerrar modal de progreso
    const modalProgreso = bootstrap.Modal.getInstance(document.getElementById('modalProgresoAnalisis'));
    if (modalProgreso) {
        modalProgreso.hide();
    }
    
    // Mostrar error
    mostrarNotificacion(`‚ùå Error en an√°lisis: ${error}`, 'danger');
}

function mostrarNotificacion(mensaje, tipo = 'info') {
    const notif = document.createElement('div');
    notif.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    notif.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    
    notif.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notif);
    
    setTimeout(() => {
        if (notif.parentNode) {
            notif.parentNode.removeChild(notif);
        }
    }, 5000);
}
</script>

<style>
.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.modal-content {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.progress {
    height: 8px;
}

.alert {
    border: none;
    border-radius: 8px;
}

.btn {
    transition: all 0.2s ease-in-out;
}

.btn:hover {
    transform: translateY(-1px);
}

.position-fixed {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
</style>

{% endblock %}